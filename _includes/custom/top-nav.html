<!-- The Top Navigation Bar -->

<div id="top-nav" aria-label="Top Navigation">
  <div class="profile-wrapper">
    <a href="{{ '/' | relative_url }}" id="avatar" class="rounded-circle">
      {%- if site.avatar != empty and site.avatar -%}
        {%- capture avatar_url -%}
          {% include media-url.html src=site.avatar %}
        {%- endcapture -%}
        <img src="{{- avatar_url -}}" alt="avatar" onerror="this.style.display='none'">
      {%- endif -%}
    </a>

    <a class="site-title" href="{{ '/' | relative_url }}">{{ site.title }}</a>
  </div>

  <!-- Hamburger menu toggle for mobile -->
  <button type="button" class="menu-toggle" aria-label="Toggle Menu">
    <i class="fas fa-bars"></i>
  </button>

  <nav class="nav">
    <!-- home -->
    <li class="nav-item{% if page.layout == 'home' %}{{ " active" }}{% endif %}">
      <a href="{{ '/' | relative_url }}" class="nav-link">
        <i class="fa-fw fas fa-home"></i>
        <span>{{ site.data.locales[include.lang].tabs.home | default: "Home" }}</span>
      </a>
    </li>
    <!-- the real tabs -->
    {% for tab in site.tabs %}
      <li class="nav-item{% if tab.url == page.url %}{{ " active" }}{% endif %}">
        <a href="{{ tab.url | relative_url }}" class="nav-link">
          <i class="fa-fw {{ tab.icon }}"></i>
          {% capture tab_name %}{{ tab.url | split: '/' | last }}{% endcapture %}

          <span>{{ site.data.locales[include.lang].tabs[tab_name] | default: tab.title }}</span>
        </a>
      </li>
    {% endfor %}

    <!-- Toggle theme mode -->
    {% unless site.theme_mode %}
      <li class="nav-item">
        <button type="button" class="btn nav-link" aria-label="Switch Mode" id="mode-toggle">
          <i class="fas fa-adjust"></i>
        </button>
      </li>
    {% endunless %}
  </nav>
</div>

<div id="search-wrapper">
  <search id="search" class="d-flex align-items-center">
    <i class="fas fa-search fa-fw"></i>
    <input
      class="form-control"
      id="search-input"
      type="search"
      aria-label="search"
      autocomplete="off"
      placeholder="{{ site.data.locales[include.lang].search.hint | default: 'Search' | capitalize }}..."
    >
  </search>
</div>

<!-- Inline script for mobile menu with improved mobile touch functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get navigation elements
    const topNav = document.getElementById('top-nav');
    const menuToggle = document.querySelector('.menu-toggle');
    
    if (!topNav || !menuToggle) return;
    
    // Always make sure menu toggle is visible on mobile
    function checkViewport() {
      if (window.innerWidth <= 849) {
        menuToggle.style.display = 'block';
      }
    }
    
    // Check on load
    checkViewport();
    
    // Check on resize
    window.addEventListener('resize', checkViewport);
    
    // Handle menu toggle interaction with better touch support
    function toggleMenu(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      topNav.classList.toggle('menu-active');
    }
    
    // Add multiple event listeners for better mobile compatibility
    menuToggle.addEventListener('click', toggleMenu);
    
    // Ensure mobile button works with touch events too - crucial for mobile devices
    menuToggle.addEventListener('touchstart', function(e) {
      e.preventDefault();
      toggleMenu(e);
    }, {passive: false});
    
    // Improved touchend handler (more reliable on mobile)
    menuToggle.addEventListener('touchend', function(e) {
      e.preventDefault();
    }, {passive: false});
    
    // Handle clicks/touches outside the menu to close it
    document.addEventListener('click', function(e) {
      if (topNav.classList.contains('menu-active') && 
          !topNav.contains(e.target) || 
          e.target.closest('.nav-link')) {
        topNav.classList.remove('menu-active');
      }
    });
    
    // Additional touch event for document to handle mobile touchstart outside menu
    document.addEventListener('touchstart', function(e) {
      if (topNav.classList.contains('menu-active') && 
          !topNav.contains(e.target) || 
          e.target.closest('.nav-link')) {
        topNav.classList.remove('menu-active');
      }
    }, {passive: true});
    
    // Hide/show navbar on scroll with improved threshold for mobile
    let lastScrollTop = 0;
    const delta = 5;
    const navbarHeight = topNav.offsetHeight;
    const showThreshold = 100;
    
    window.addEventListener('scroll', function() {
      const st = window.pageYOffset || document.documentElement.scrollTop;
      
      if (Math.abs(lastScrollTop - st) <= delta) return;
      
      if (st > showThreshold) {
        topNav.classList.add('nav-up');
      } else {
        topNav.classList.remove('nav-up');
      }
      
      lastScrollTop = st;
    });
  });
</script>